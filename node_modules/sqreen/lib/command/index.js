/**
 * Copyright (c) 2016 Sqreen. All Rights Reserved.
 * Please refer to our terms for more information: https://www.sqreen.io/terms.html
 */
'use strict';
const Logger = require('../logger');
const Exception = require('../exception');
const Backend = require('../backend');
const Agent = require('../agent');
const Actions = require('./actions');

const AGENT_VERSION = require('../../package.json').version;

/**
 * Command executor
 * @param command
 */
module.exports.execute = function (command) {

    if (!command.name || !command.uuid) {
        Logger.INFO('Sqreen tried to execute an empty command');
        return Promise.resolve();
    }
    command.params = command.params || [];

    if (Actions[command.name]) { // is the command known
        Logger.DEBUG(`execute command ${command.name} with params ${JSON.stringify(command.params)}`);
        return Actions[command.name](command.params, command.uuid)
            .then((output) => {

                const response = {};
                response[command.uuid] = {
                    status: true,
                    output
                };

                if (Agent.STARTED() && Agent.SESSION_ID()) {
                    return Backend.commands(Agent.SESSION_ID(), response);
                }
                Logger.ERROR('Sqreen is not connected. Cannot report command result');
                return Promise.resolve();
            })
            .catch((err) => {

                Logger.INFO(`Sqreen command ${command.name} failed`);
                // TODO: response with false ?
                return Exception.report(err);
            });
    }
    Logger.INFO(`Command unsupported by Sqreen Agent ${AGENT_VERSION}: ${command.name}`);
    return Exception.report(new Error(`Command unsupported by Sqreen Agent ${AGENT_VERSION}: ${command.name}`));
};
