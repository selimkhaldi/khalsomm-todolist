/**
 * Copyright (c) 2016 Sqreen. All Rights Reserved.
 * Please refer to our terms for more information: https://www.sqreen.io/terms.html
 */
'use strict';
const EventEmitter = require('events');
/**
 * Return the callback for enabling storage
 * @author vdeturckheim
 * @framework none
 * @target *
 * @returns {{post: post}}
 */
module.exports.getCbs = function () {

    return {
        pre: function (args, value, rule, selfObject, session) {

            if (!session || !session.raw || !session.raw.bind) {
                return;
            }
            const toBind = (rule && rule.data && rule.data.values && rule.data.values[0] && rule.data.values[0].bindRanks)
                || Array.apply(null, { length: args.length }).map(Number.call, Number);

            for (let i = 0; i < toBind.length; ++i) {
                const rank = toBind[i];
                if (typeof args[rank] === 'function') {
                    args[rank] = session.raw.bind(args[rank]);
                }
            }
        },
        post: function (arg, value, rule, selfObject, session) {

            if (value && value instanceof EventEmitter) {
                session.raw.bindEmitter(value);
            }
        }
    };
};
