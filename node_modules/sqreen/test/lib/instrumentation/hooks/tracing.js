/**
 * Copyright (c) 2016 Sqreen. All Rights Reserved.
 * Please refer to our terms for more information: https://www.sqreen.io/terms.html
 */
'use strict';
const Code = require('code');
const Lab = require('lab');
const lab = exports.lab = Lab.script();

const describe = lab.describe;
const it = lab.it;
const after = lab.after;
const expect = Code.expect;
const EventEmitter = require('events').EventEmitter;
const Util = require('util');

const Tracing = require('../../../../lib/instrumentation/hooks/tracing');

after((done) => {

    require('continuation-local-storage').destroyNamespace('sqreen_session');
    done();
});

describe('Instrumentation', () => {

    describe('isEmitter', () => {

        it('should do the mdgsuhlhjgfadlusygdfa coverage', { plan: 4 }, (done) => {

            expect(Tracing._isEmitter({})).to.be.false();
            expect(Tracing._isEmitter({ on: 1 })).to.be.false();
            expect(Tracing._isEmitter({ on: 1, addListener: 1 })).to.be.false();
            expect(Tracing._isEmitter({ on: 1, addListener: 1, emit: 1 })).to.be.true();
            done();
        });
    });

    describe('Tracing', () => {

        it('should not work since req/res are not EventEmitters ', { plan: 2 }, (done) => {

            const MockerTracing = require('../../../../lib/instrumentation/hooks/tracing');

            const Server = function Server() {

                EventEmitter.apply(this, arguments);
            };
            Util.inherits(Server, EventEmitter);

            const module = { Server };
            MockerTracing.enable(module, {});
            const server = new module.Server();
            server.addListener('request', (req, res) => {

                expect(req).to.equal('req');
                expect(res).to.equal('res');
                done();
            });

            server.emit('request', 'req', 'res');
        });

        it('should trace calls', { plan: 5 }, (done) => {

            const Server = function Server() {

                EventEmitter.apply(this, arguments);
            };
            Util.inherits(Server, EventEmitter);

            const module = { Server };
            Tracing.enable(module, {});
            const server = new module.Server();

            const _req = new EventEmitter();
            _req.name = 'req';
            const _res = new EventEmitter();
            _res.name = 'res';

            server.addListener('request', (req, res) => {

                expect(req.name).to.equal('req');
                expect(res.name).to.equal('res');

                const session = require('continuation-local-storage').getNamespace('sqreen_session');

                expect(session.get('req').name).to.equal('req');
                expect(session.get('req').__sqreen_uuid).to.exist();
                expect(session.get('res').name).to.equal('res');

                res.on('finish', () => {

                    done();
                });
                res.emit('finish');

            });

            server.emit('request', _req, _res);
        });

        it('should ignore non request events', { plan: 5 }, (done) => {

            const Server = function Server() {

                EventEmitter.apply(this, arguments);
            };
            Util.inherits(Server, EventEmitter);

            const module = { Server };
            Tracing.enable(module, {});
            const server = new module.Server();

            expect(server.emit.__wrapped).to.be.true();
            const _req = new EventEmitter();
            _req.name = 'req';
            const _res = new EventEmitter();
            _res.name = 'res';

            server.addListener('request0', (req, res) => {

                expect(req.name).to.equal('req');
                expect(res.name).to.equal('res');

                const session = require('continuation-local-storage').getNamespace('sqreen_session');

                expect(session.get('req')).to.not.exist();
                expect(session.get('res')).to.not.exist();
                done();
            });

            server.emit('request0', _req, _res);
        });
    });
});

