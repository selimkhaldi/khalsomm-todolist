/**
 * Copyright (c) 2016 Sqreen. All Rights Reserved.
 * Please refer to our terms for more information: https://www.sqreen.io/terms.html
 */
'use strict';
//noinspection Eslint
var nodeVersionSupported = require('./versionCheck')(process.version);

if (!nodeVersionSupported) {
    console.error('The current version of Node.js is ' + process.version + ' which is not compatible with Sqreen');
    console.error('Sqreen will not start.');
    console.error('Documentation can be found at https://doc.sqreen.io/docs/nodejs-agent-compatibility');
}
else {
    // TODO: module for that
    //noinspection Eslint
    var unwanted = false;
    //noinspection Eslint
    var Module = require('module');
    //noinspection Eslint
    var fileName;
    //noinspection Eslint
    var opbeat = false;

    try {
        //noinspection Eslint
        fileName = Module._resolveFilename('opbeat', module.parent); // will throw if opbeat is not here ... what we do is we resolve opbeat package using the path of the parent of the current module
        unwanted = unwanted || !require.cache[fileName]; // if the main file of opbeat is in the cache, it means it has been loaded
        opbeat = true;
    }
    catch (_) {
        // ignore the thrown error
    }

// If opbeat is present and not started
    if (unwanted){
        if (opbeat) {
            console.error('Package \'opbeat\' is present but not started. Sqreen will not start.');
            console.error('Please require \'opbeat\' before \'sqreen\'.');
        }
        console.error('Documentation can be found at https://doc.sqreen.io/docs/nodejs-agent-compatibility');
// in the doc, put an env variable to override this.
    }
    else {
        require('continuation-local-storage');
        require('./lib/instrumentation'); // enables instrumentation
        require('events'); // trigger events instanciation, FIXME: otherwise header insertion do not work anymore...
        //noinspection Eslint
        var Logger = require('./lib/logger');
        Logger.DEBUG('Starting Sqreen');

        //noinspection Eslint
        var Config = require('./lib/config').getConfig(); // read the conf here
        Logger.DEBUG('Sqreen config loaded');

        //noinspection Eslint
        var Agent = require('./lib/agent');

        //noinspection Eslint
        /**
         * This function will be executed before the process ends
         */
        var preExitHandler = function () {

            //noinspection Eslint
                Agent.stop()
                .then(function () {

                    process.exit();
                });
        };
        // https://nodejs.org/api/process.html#process_event_beforeexit
        // be fore exit, we logout sqreen
        process.on('beforeExit', preExitHandler);
        process.on('SIGINT', preExitHandler);

        if (Config && Config.token && !Agent.STARTED()) {

            if (!Config.run_in_test) {
                Agent.start(Config);
            }
        }
        else if (Agent.STARTED()) {

            Logger.WARN('Sqreen was already started');
        }
        else if (!Config) {
            Logger.ERROR('no Sqreen config found');
            console.warn('Your application is NOT currently protected by Sqreen.');
        }
        else {
            Logger.ERROR('Sorry but we couldn\'t find your Sqreen token');
            console.warn('Your application is NOT currently protected by Sqreen.');
        }
    }
}
